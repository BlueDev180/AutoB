:root{
      --bg:#0b0e14;
      --panel:#0f1420;
      --panel2:#0c1220;
      --b:#1d2638;
      --b2:#2a3a63;
      --text:#e8eefc;
      --muted:#9fb0d8;
      --good:#55d38a;
      --bad:#ff5c7a;
      --accent:#6aa6ff;

      --rar-common:#8ea0c6;
      --rar-uncommon:#55d38a;
      --rar-rare:#6aa6ff;
      --rar-epic:#b27bff;
      --rar-legendary:#ffd36a;

      --dmg:#ff5c7a;
      --heal:#55d38a;
      --shield:#6aa6ff;
      --tag:#cfe0ff;
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html, body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      overflow:hidden;
    }

    .versionTag{
      position:fixed;
      top:8px;
      right:12px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(15,20,32,0.82);
      border: 1px solid rgba(42,58,99,0.85);
      color: var(--muted);
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.04em;
      z-index: 9000;
      pointer-events: none;
    }

    .app{
      height:100dvh;
      padding: env(safe-area-inset-top) 10px env(safe-area-inset-bottom) 10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
      overflow:hidden;
    }

    .screen{
      display:none;
      flex:1 1 auto;
      min-height:0;
      overflow:hidden;
    }
    body[data-screen="menu"] .screenMenu{ display:flex; }
    body[data-screen="planning"] .screenPlanning{ display:flex; }
    body[data-screen="battle"] .screenBattle{ display:flex; }

    /* ===== Toast ===== */
    #toast{
      position:fixed;
      left:50%;
      top: calc(env(safe-area-inset-top) + 10px);
      transform: translateX(-50%) translateY(-8px);
      max-width: 92vw;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(15,20,32,0.92);
      border: 1px solid rgba(42,58,99,0.95);
      color: var(--text);
      font-weight: 1000;
      font-size: 14px;
      line-height: 1.2;
      text-align:center;
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      backdrop-filter: blur(10px);
      transition: opacity 120ms ease, transform 250ms ease, box-shadow 250ms ease, border-color 250ms ease;

      white-space: normal;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #toast.show{ opacity: 1; transform: translateX(-50%) translateY(0px); }
    #toast.good{ border-color: rgba(85,211,138,0.70); box-shadow: 0 0 0 1px rgba(85,211,138,0.12) inset; }
    #toast.bad{ border-color: rgba(255,92,122,0.70); box-shadow: 0 0 0 1px rgba(255,92,122,0.12) inset; }

    .panel{
      background:var(--panel);
      border:1px solid var(--b);
      border-radius:14px;
      padding:10px;
      overflow:hidden;
    }
    .panelTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
      min-width:0;
    }
    .panelTitle{
      font-size:13px;
      font-weight:1000;
      color:#cfe0ff;
      white-space:nowrap;
    }
    .hint{
      font-size:12px;
      color:var(--muted);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 62vw;
    }

    button{
      background:#1a2540;
      color:var(--text);
      border:1px solid var(--b2);
      border-radius:12px;
      padding:12px 14px;
      font-weight:1000;
      font-size:13px;
      line-height:1;
      min-height:44px;
      touch-action: manipulation;
      white-space:nowrap;
    }
    button:disabled{ opacity:.5; }
    .btnPrimary{
      border-color: rgba(106,166,255,0.85);
      box-shadow: 0 0 0 1px rgba(106,166,255,0.20) inset;
    }
    .btnGhost{ background:#121a2c; border-color:#24345b; }

    .pill{
      border:1px solid var(--b2);
      background:#111a2c;
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      color:#b9c6e6;
      white-space:nowrap;
    }
    .pillGood{ border-color: rgba(85,211,138,0.75); color:#c9ffe2; }
    .pillBad{ border-color: rgba(255,92,122,0.75); color:#ffd0d9; }

    /* ===== MENU ===== */
    .menuWrap{ flex:1 1 auto; min-height:0; display:flex; flex-direction:column; gap:10px; overflow:hidden; justify-content:center; }
    .menuCard{ width:min(520px, 100%); margin:0 auto; display:flex; flex-direction:column; gap:10px; }
    .menuTitle{ font-size:18px; font-weight:1200; letter-spacing:0.4px; color:#d6e4ff; margin-bottom:2px; text-align:center; }
    .menuSub{ font-size:12px; color:var(--muted); text-align:center; line-height:1.35; margin-bottom:6px; }
    .menuBtns{ display:flex; flex-direction:column; gap:10px; }
    .howto{
      display:none;
      background:rgba(12,18,32,0.92);
      border:1px solid rgba(42,58,99,0.95);
      border-radius:14px;
      padding:12px;
      line-height:1.35;
      color:#cfe0ff;
      font-size:13px;
    }
    body[data-howto="open"] .howto{ display:block; }

    /* ===== PLANNING ===== */
    .planningWrap{ flex:1 1 auto; min-height:0; display:flex; flex-direction:column; gap:10px; overflow:hidden; }
    .topPlanning{ flex:0 0 auto; }
    .topGrid{ display:grid; grid-template-columns: 1fr; gap:10px; }
    .phaseRow{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .phaseLabel{
      font-weight:1100;
      font-size:12px;
      letter-spacing:1px;
      color:#cfe0ff;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--b2);
      background:#0e1627;
      white-space:nowrap;
    }

    .statStrip{ display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:8px; }
    @media (max-width: 420px){ .statStrip{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    .statTile{
      background:var(--panel2);
      border:1px solid var(--b);
      border-radius:14px;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:2px;
      min-height:64px;
    }
    .statTile .lab{ font-size:11px; color:#b9c6e6; font-weight:900; letter-spacing:0.3px; }
    .statTile .val{ font-size:20px; font-weight:1200; color:var(--text); line-height:1.05; }

    .actionRow{ display:grid; grid-template-columns: 1fr 1.2fr; gap:8px; }
    @media (max-width: 420px){ .actionRow{ grid-template-columns: 1fr 1fr; } }

    .planningBody{ flex:1 1 auto; min-height:0; display:flex; flex-direction:column; gap:10px; overflow:hidden; }
    .shopPanel{ flex: 1 1 58%; min-height:0; display:flex; flex-direction:column; }
    .armyPanel{ flex: 1 1 42%; min-height:0; display:flex; flex-direction:column; }

    .shop{
      flex:1 1 auto; min-height:0; display:flex; gap:10px;
      overflow-x:auto; overflow-y:hidden;
      -webkit-overflow-scrolling: touch; scrollbar-width:none; padding-bottom:2px;
    }
    .shop::-webkit-scrollbar{ display:none; }
    .card{
      flex: 0 0 215px;
      background:var(--panel2);
      border:1px solid var(--b);
      border-radius:14px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      position:relative;
      overflow:hidden;
    }
    .rarStrip{
      position:absolute; left:0; top:0; bottom:0;
      width:6px;
      opacity:0.95;
      background: var(--rar-common);
    }
    .card h4{
      margin:0;
      font-size:15px;
      color:var(--text);
      font-weight:1100;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-width:0;
    }
    .card h4 span:first-child{
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .card .badge{
      width:10px; height:10px; border-radius:999px;
      background:#fff;
      flex:0 0 auto;
      box-shadow: 0 0 0 2px rgba(0,0,0,0.25);
    }
    .line{
      font-size:12px;
      color:var(--muted);
      white-space: normal;
      line-height: 1.25;
      word-break: break-word;
    }

    .armyBar{
      flex:1 1 auto;
      min-height:0;
      display:flex;
      gap:10px;
      overflow-x:auto;
      overflow-y:hidden;
      -webkit-overflow-scrolling: touch;
      scrollbar-width:none;
      padding-bottom:2px;
    }
    .armyBar::-webkit-scrollbar{ display:none; }
    .chip{
      flex:0 0 auto;
      background:#12203b;
      border:1px solid var(--b2);
      border-radius:12px;
      padding:10px 12px;
      min-width: 168px;
      display:flex;
      flex-direction:column;
      gap:4px;
      position:relative;
      overflow:hidden;
      border-left: 6px solid #6aa6ff;
    }
    .chip .t{ font-weight:1100; font-size:13px; display:flex; align-items:center; justify-content:space-between; gap:8px; min-width:0; }
    .chip .t span:first-child{ min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .chip .s{ font-size:12px; color:#cfe0ff; opacity:.95; }
    .chip .m{
      font-size:12px;
      color:var(--muted);
      line-height:1.25;
      white-space: normal;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      padding-top: 1px;
    }

    .rarMini{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(42,58,99,0.95);
      background:#10192e;
      color:#cfe0ff;
      line-height:1;
      flex:0 0 auto;
      white-space:nowrap;
    }

    .armyHeaderRight{
      display:flex;
      gap:8px;
      align-items:center;
      flex:0 0 auto;
    }
    .armyHeaderRight button{
      min-height:40px;
      padding:10px 12px;
    }

    /* ===== BATTLE ===== */
    .battleWrap{ flex:1 1 auto; min-height:0; display:flex; flex-direction:column; overflow:hidden; }
    .battleCanvasWrap{
      flex:1 1 auto;
      min-height:0;
      background:var(--panel2);
      border:1px solid var(--b);
      border-radius:14px;
      overflow:hidden;
      position:relative;
    }
    canvas{ width:100%; height:100%; display:block; }

    .overlayTop{
      position:absolute;
      top:10px;
      left:10px;
      right:10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      pointer-events:none;
    }
    .overlayTop .left{ display:flex; flex-direction:column; gap:8px; min-width:0; pointer-events:none; }
    .overlayTop .right{ display:flex; gap:8px; align-items:center; pointer-events:none; }
    .overlayTop .left .pill{ white-space:normal; line-height:1.15; max-width: 76vw; }
    .overlayTop button{ pointer-events:auto; }

    .resultBox{
      position:absolute;
      left:10px;
      right:10px;
      top:50%;
      transform:translateY(-50%);
      background:rgba(15,20,32,0.92);
      border:1px solid rgba(42,58,99,0.95);
      border-radius:16px;
      padding:14px;
      backdrop-filter: blur(10px);
      display:none;
      z-index: 30;
    }
    body[data-result="show"] .resultBox{ display:block; }
    .resultBox .rTitle{ font-weight:1200; font-size:16px; margin-bottom:6px; }
    .resultBox .rText{ font-size:13px; color:var(--muted); margin-bottom:10px; line-height:1.35; }
    .resultBox .rBtns{ display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap; }

    /* ===== Fullscreen overlays ===== */
    .fsOverlay{
      position:fixed;
      inset:0;
      z-index: 20000;
      padding: calc(env(safe-area-inset-top) + 10px) 10px calc(env(safe-area-inset-bottom) + 10px) 10px;
      background: rgba(6,8,12,0.78);
      backdrop-filter: blur(10px);
      display:none;
      overflow:hidden;
      touch-action: pan-y;
      overscroll-behavior: contain;
    }
    body[data-overlay="augment"] #ovAugment{ display:block; }
    body[data-overlay="item"] #ovItem{ display:block; }
    body[data-overlay="node"] #ovNode{ display:block; }
    body[data-overlay="event"] #ovEvent{ display:block; }
    body[data-overlay="inventory"] #ovInventory{ display:block; }
    body[data-overlay="synergies"] #ovSynergies{ display:block; }
    body[data-overlay="bonuses"] #ovBonuses{ display:block; }
    body[data-overlay="replace"] #ovReplace{ display:block; }

    .ovCard{
      height:100%;
      max-width: 560px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:hidden;
      min-height:0;
      touch-action: pan-y;
    }
    .ovHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-width:0;
    }
    .ovTitle{ font-size:16px; font-weight:1200; color:#d6e4ff; }
    .ovSub{ font-size:12px; color:var(--muted); line-height:1.35; }
    .ovBody{
      flex:1 1 auto;
      min-height:0;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .vStack{
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      display:flex;
      flex-direction:column;
      gap:10px;
      padding-bottom:2px;
      touch-action: pan-y;
    }
    .choiceCard{
      background: rgba(12,18,32,0.92);
      border: 1px solid rgba(42,58,99,0.95);
      border-radius: 14px;
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:6px;
      position:relative;
      overflow:hidden;
    }
    .choiceCard .name{ font-weight:1200; display:flex; align-items:center; justify-content:space-between; gap:10px; min-width:0; }
    .choiceCard .name span:first-child{ min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .choiceCard .desc{ font-size:12px; color:var(--muted); line-height:1.35; word-break:break-word; }
    .choiceCard button{ width:100%; }

    /* ===== Bonuses overlay readability (no clamp, no cut off) ===== */
    #ovBonuses .vStack{
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      min-height:0;
      padding-bottom:10px;
    }
    #ovBonuses .choiceCard{
      padding:14px;
      border-radius:16px;
      overflow:visible;
    }
    #ovBonuses .choiceCard .name span:first-child{
      white-space:normal;
      overflow:visible;
      text-overflow:clip;
      display:block;
    }
    #ovBonuses .choiceCard .desc{
      white-space:normal;
      overflow:visible;
      display:block;
      -webkit-line-clamp: unset !important;
      -webkit-box-orient: initial !important;
    }

    /* Inventory layout: ALWAYS 2 columns, both scroll independently */
    .twoCols{
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:0;
      flex:1 1 auto;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      align-items: stretch;
    }
    .invList{
      min-height:0;
      flex:1 1 auto;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      display:flex;
      flex-direction:column;
      gap:12px;
      touch-action: pan-y;
      padding-bottom:2px;
    }

    /* Hide old tab UI completely */
    #invTabsWrap{ display:none !important; }

    .slotRow{
      display:flex; gap:6px; flex-wrap:wrap;
      align-items:center;
    }
    .slotPill{
      font-size:11px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid rgba(42,58,99,0.95);
      background:#0f1830;
      color:#cfe0ff;
      line-height:1;
      white-space:nowrap;
    }
    .slotEmpty{ opacity:0.55; }

    /* ===== Inventory readability: make cards roomier + clamp text cleanly ===== */
    #ovInventory .panel{ padding:10px 12px; border-radius:16px; overflow:visible; }
    #ovInventory .ovHeader{ overflow:visible; flex-wrap:nowrap; }
    #ovInventory .ovHeader > button{ flex-shrink:0; min-width:60px; }
    #ovInventory .choiceCard{
      padding:16px 14px;
      border-radius:16px;
      gap:10px;
      min-height:86px;
    }
    /* Inventory: fixed height, split 50/50 with independent scroll per panel */
    #ovInventory .ovCard{ overflow:hidden; }
    #ovInventory .ovBody{ overflow:hidden; flex:1 1 auto; min-height:0; }
    #ovInventory #invGrid{
      flex:1 1 auto; min-height:0; overflow:hidden;
      display:flex; flex-direction:column; gap:10px;
    }
    #ovInventory #invPaneItems{
      flex:0 0 40%; min-height:0; overflow:hidden;
      display:flex; flex-direction:column; gap:8px;
    }
    #ovInventory #invPaneUnits{
      flex:1 1 auto; min-height:0; overflow:hidden;
      display:flex; flex-direction:column; gap:8px;
    }
    #ovInventory .invList{
      flex:1 1 auto; min-height:0;
      overflow:auto; -webkit-overflow-scrolling:touch;
      display:flex; flex-direction:column; gap:10px;
      padding-bottom:8px;
    }
    #ovInventory .choiceCard{ flex-shrink:0; overflow:visible; min-height:auto; }
    #ovInventory .choiceCard .name{ font-size:14px; line-height:1.2; }
    #ovInventory .choiceCard .name span:first-child{
      white-space: normal;
      display:-webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    #ovInventory .choiceCard .desc{
      font-size:13px;
      line-height:1.4;
      display:-webkit-box;
      -webkit-box-orient: vertical;
      overflow:hidden;
      text-overflow:ellipsis;
      -webkit-line-clamp: 2;
    }
    #ovInventory .choiceCard.invItem .desc{ -webkit-line-clamp: 1; }
    #ovInventory .choiceCard.invUnit .desc{ -webkit-line-clamp: 3; }

    /* Selected item bar */
    .selBar{
      display:none;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-width:0;
    }
    .selLeft{
      min-width:0;
      display:flex;
      align-items:center;
      gap:8px;
      overflow:hidden;
    }
    .selLeft .pill{ max-width: 64vw; overflow:hidden; text-overflow:ellipsis; }
    .miniBtn{
      min-height:34px !important;
      padding:8px 10px !important;
      border-radius:999px !important;
      font-size:12px !important;
      width:auto !important;
      white-space:nowrap !important;
    }

    /* Equipped chips (unit cards) */
    .equipWrap{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .equipRow{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .equipChip{
      display:flex;
      align-items:center;
      gap:8px;
      border:1px solid rgba(42,58,99,0.95);
      background:#0f1830;
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      color:#cfe0ff;
      line-height:1;
      max-width:100%;
      overflow:hidden;
    }
    .equipChip .txt{
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .btnInvInfo{
      display:inline-flex; align-items:center; justify-content:center;
      width:20px; height:20px; border-radius:50%;
      background:rgba(106,166,255,0.15); border:1px solid rgba(106,166,255,0.4);
      color:#6aa6ff; font-size:12px; font-weight:800;
      padding:0; cursor:pointer; vertical-align:middle; margin-left:6px;
    }
    .tierBadge{
      display:inline-block;
      font-size:10px;
      font-weight:800;
      padding:1px 5px;
      border-radius:999px;
      background:linear-gradient(135deg,#a855f7,#7c3aed);
      color:#fff;
      line-height:1.4;
      vertical-align:middle;
      margin-left:4px;
    }
    .equipFxLine{
      font-size:12px;
      color:var(--muted);
      line-height:1.25;
      display:-webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .smallTag{
      font-size:11px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid rgba(42,58,99,0.95);
      background:#10192e;
      color:#cfe0ff;
      line-height:1;
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .smallTag.muted{ opacity:0.65; }

    /* Action row inside unit cards (inventory) */
    .unitActions{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:center;
    }
    .unitActions.one{ grid-template-columns: 1fr; }
    .unitActions .pillLike{
      min-height:44px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      border-radius:12px;
      border:1px solid rgba(42,58,99,0.95);
      background:#10192e;
      color:#b9c6e6;
      font-weight:1000;
      font-size:12px;
      padding:12px 10px;
    }

    @media (max-width: 380px){
      .card{ flex-basis: 205px; }
      .chip{ min-width: 156px; }
      button{ padding:12px 12px; }
      .statTile .val{ font-size:19px; }
      #toast{ font-size:13px; }
      #ovInventory .choiceCard{ padding:16px 12px; }
      .selLeft .pill{ max-width: 58vw; }
    }
