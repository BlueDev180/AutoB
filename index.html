<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>Auto Battler – r2-sprite</title>
<style>
  html,body{margin:0;height:100svh;background:#121214;overscroll-behavior:none;font-family:-apple-system,system-ui,sans-serif}
  canvas{position:fixed;inset:0;display:block;touch-action:manipulation}
  .boot{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#eaeaea;gap:8px}
  .tag{color:#7bd7ff;font-size:12px}
  .err{background:#1a0000}.err .msg{max-width:92vw;color:#ffb8b8;white-space:pre-wrap;text-align:center}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="boot" class="boot">
  <div class="tag">Build r2-sprite</div>
  <div>Loading…</div>
  <div class="msg"></div>
</div>

<script>
(function(){
  // -------- Boot helpers --------
  var BUILD="r2-sprite";
  var boot=document.getElementById('boot');
  var bootMsg=boot.querySelector('.msg');
  function ok(){ boot.style.display='none'; }
  function fail(e){ boot.classList.add('err'); bootMsg.textContent=(e&&(e.stack||e.message))?(e.stack||e.message):String(e); }

  try{
    // -------- Canvas & layout (mobile-safe) --------
    var canvas=document.getElementById('c');
    var ctx=canvas.getContext('2d',{alpha:false});
    var DPR = Math.min(window.devicePixelRatio||1, 1.5); // cap DPR for iPhone
    function vv(){ var v=window.visualViewport;
      var w=Math.min(innerWidth||1e9, document.documentElement.clientWidth||1e9, v?v.width:1e9);
      var h=Math.min(innerHeight||1e9, document.documentElement.clientHeight||1e9, v?v.height:1e9);
      return {w:Math.floor(w),h:Math.floor(h)};
    }
    function setSize(){
      var s=vv(); canvas.width=Math.floor(s.w*DPR); canvas.height=Math.floor(s.h*DPR);
      canvas.style.width=s.w+"px"; canvas.style.height=s.h+"px";
      ctx.setTransform(DPR,0,0,DPR,0,0);
    }
    addEventListener('resize',setSize,{passive:true});
    addEventListener('orientationchange',setSize,{passive:true});
    if(visualViewport){
      visualViewport.addEventListener('resize',setSize,{passive:true});
      visualViewport.addEventListener('scroll',setSize,{passive:true});
    }
    setSize();

    // -------- Grid & UI layout --------
    var COLS=5, ROWS=3;
    var SHOW_SHOP=true, UI_SHOP=196, UI_COMPACT=96;
    function uiH(){ return SHOW_SHOP?UI_SHOP:UI_COMPACT; }
    var L={cell:48,originX:0,originY:24,gridW:0,gridH:0,yUI:0,vw:0,vh:0};
    function layout(){
      var s=vv(), TOP=36, BTM=2, availH=Math.max(60, s.h-uiH()-TOP-BTM);
      var cell=Math.max(18, Math.min(Math.floor(availH/ROWS), Math.floor(s.w/COLS)));
      var gw=COLS*cell, gh=ROWS*cell, ox=Math.floor((s.w-gw)/2);
      var oy=Math.floor((s.h-uiH()-gh)/2); oy=Math.max(12, Math.min(oy, s.h-uiH()-gh-8));
      var yUI=s.h-uiH()-BTM; yUI=Math.max(oy+gh+8, yUI);
      L={cell:cell,originX:ox,originY:oy,gridW:gw,gridH:gh,yUI:yUI,vw:s.w,vh:s.h};
    }
    layout();

    // -------- Colors / UI --------
    var C={ bg:'#121214', grid:'#2b2b2b', ui:'#1e1e1e', hp:'#e43a3a', text:'#eaeaea', accent:'#ffd45a', start:'#7a50a0' };

    // -------- Spritesheet (procedurally generated) --------
    // We draw a tiny 16x16 pixel-art sheet with 3 clips x 4 frames per unit.
    // Layout per unit: rows = idle(0), walk(1), attack(2). Frames: 0..3 across.
    // Units order: Brawler(0 block), Archer(1), Cleric(2), Enemy(3). Each block is 4 rows high (1 spacer row).
    var SPR={img:null, w:256, h:128, tile:16, atlas:{}};

    function pxRect(pctx,x,y,w,h,col){ pctx.fillStyle=col; pctx.fillRect(x,y,w,h); }
    function drawBrawler(pctx,x,y,frame,clip){
      // base body
      pxRect(pctx,x+3,y+4,10,8,'#c8503c'); // armor
      pxRect(pctx,x+5,y+3,6,2,'#8e3a2c'); // shadow
      // head bob by clip/frame
      var bob=(clip==='idle')?(frame%2): (clip==='walk'?((frame===1||frame===3)?1:0):1);
      pxRect(pctx,x+6,y+1+bob,4,3,'#e7d7c9'); // head
      // sword flash on attack
      if(clip==='attack'){
        var f=frame; pxRect(pctx,x+12,y+4,3,1,'#ffe9a6'); if(f>=2) pxRect(pctx,x+12,y+3,3,1,'#ffffff');
      }
    }
    function drawArcher(pctx,x,y,frame,clip){
      pxRect(pctx,x+4,y+5,8,7,'#50c85a'); // tunic
      var bob=(clip==='idle')?(frame%2): (clip==='walk'?((frame===1||frame===3)?1:0):1);
      pxRect(pctx,x+6,y+2+bob,4,3,'#e7d7c9'); // head
      // bow line
      pxRect(pctx,x+2,y+6,2,6,'#a07c3a');
      if(clip==='attack' && frame>=2){ pxRect(pctx,x+11,y+6,3,1,'#ffe9a6'); }
    }
    function drawCleric(pctx,x,y,frame,clip){
      pxRect(pctx,x+4,y+5,8,7,'#78b4dc'); // robe
      var bob=(clip==='idle')?(frame%2): (clip==='walk'?((frame===1||frame===3)?1:0):1);
      pxRect(pctx,x+6,y+2+bob,4,3,'#e7d7c9'); // head
      // staff
      pxRect(pctx,x+2,y+4,2,8,'#b9b9b9');
      if(clip==='attack' && frame>=2){ pxRect(pctx,x+11,y+6,2,2,'#a6f5c7'); }
    }
    function drawEnemy(pctx,x,y,frame,clip){
      pxRect(pctx,x+3,y+4,10,8,'#b3b3b3'); // body
      var bob=(clip==='idle')?(frame%2): (clip==='walk'?((frame===1||frame===3)?1:0):1);
      pxRect(pctx,x+6,y+2+bob,4,3,'#d2d2d2'); // head
      if(clip==='attack' && frame>=2){ pxRect(pctx,x+1,y+5,3,1,'#ffb27c'); }
    }

    function buildSprites(){
      var p=document.createElement('canvas'); p.width=SPR.w; p.height=SPR.h;
      var pc=p.getContext('2d',{alpha:true}); pc.imageSmoothingEnabled=false;
      pc.clearRect(0,0,SPR.w,SPR.h);

      var clips=['idle','walk','attack']; var frames=4; var tile=SPR.tile;
      function drawUnitBlock(unitIndex, drawFn){
        var blockY=unitIndex*(tile*4); // each unit uses 4 rows (3 clips + spacer)
        for(var c=0;c<clips.length;c++){
          for(var f=0;f<frames;f++){
            var dx=f*tile + unitIndex*tile*frames; // frames across per unit block
            var dy=c*tile + blockY;
            // clear cell
            pc.clearRect(dx,dy,tile,tile);
            drawFn(pc,dx,dy,f,clips[c]);
          }
        }
        // atlas entries
        SPR.atlas[unitIndex]={
          idle:  Array.from({length:4},(_,f)=>({x:unitIndex*tile*frames+f*tile,y:blockY+0*tile,w:tile,h:tile})),
          walk:  Array.from({length:4},(_,f)=>({x:unitIndex*tile*frames+f*tile,y:blockY+1*tile,w:tile,h:tile})),
          attack:Array.from({length:4},(_,f)=>({x:unitIndex*tile*frames+f*tile,y:blockY+2*tile,w:tile,h:tile}))
        };
      }
      drawUnitBlock(0,drawBrawler);
      drawUnitBlock(1,drawArcher);
      drawUnitBlock(2,drawCleric);
      drawUnitBlock(3,drawEnemy);

      var im=new Image(); im.src=p.toDataURL('image/png');
      SPR.img=im;
    }
    buildSprites();

    // -------- Units / stats --------
    var BASE={
      Brawler:{hp:120, atk:18, spd:1.0, range:1, role:'melee', armor:10, resist:5, color:'#c8503c'},
      Archer: {hp:70,  atk:25, spd:0.8, range:5, role:'ranged', armor:4,  resist:4, color:'#50c85a'},
      Cleric: {hp:80,  atk: 8,  spd:1.0, range:5, role:'healer', armor:6,  resist:12, color:'#78b4dc'}
    };
    function starMul(s){ return s===1?1:(s===2?1.4:1.8); }
    function scaled(b,s){ return {hp:Math.round(b.hp*starMul(s)), atk:Math.round(b.atk*starMul(s)), spd:b.spd, range:b.range,
                                  role:b.role, armor:Math.round(b.armor*starMul(s)), resist:Math.round(b.resist*starMul(s)), color:b.color}; }
    function mkUnit(name,team,cell,star){ if(!star) star=1; var s=scaled(BASE[name],star);
      return {name:name,team:team,cell:cell,star:star,alive:true,maxhp:s.hp,hp:s.hp,atk:s.atk,spd:s.spd,range:s.range,
              role:s.role,armor:s.armor,resist:s.resist,color:s.color,lastPos:null,cool:0,stepCool:0,
              anim:{clip:'idle',t:0,fps:8,frame:0,flip:(team==='enemy')}, move:null};
    }

    // -------- Game state --------
    var gold=6, floorN=1, state='shop', result=null;
    var roster=[], enemies=[], shop=[], preview=null;
    var buyAreas=[], startArea={x:0,y:0,w:0,h:0}, rerollArea={x:0,y:0,w:0,h:0}, sellArea={x:0,y:0,w:0,h:0};
    var shopBtn={x:16,y:20,w:160,h:54}, BUY_COST=2, REROLL_COST=2;

    function refillShop(){ var k=Object.keys(BASE); shop=[]; for(var i=0;i<3;i++) shop.push(k[(Math.random()*k.length)|0]); }
    function spawnEnemies(){
      enemies=[];
      var count=(floorN===1)?2:3, cols=[4,3,4,3];
      for(var i=0;i<count;i++){
        var hp=Math.floor((floorN===1)?80:90+floorN*8), atk=Math.floor((floorN===1)?10:10+floorN*3);
        enemies.push({name:'Enemy',team:'enemy',cell:{x:cols[i%cols.length],y:i%3},star:1,alive:true,maxhp:hp,hp:hp,
                      atk:atk,spd:1.0,range:1,role:'melee',armor:5+floorN,resist:3+((floorN/2)|0),
                      lastPos:null,cool:0,stepCool:0,anim:{clip:'idle',t:0,fps:8,frame:0,flip:true},move:null});
      }
    }

    // -------- Helpers --------
    function text(s,x,y,sz,c){ ctx.fillStyle=c||C.text; ctx.font=(sz||16)+'px -apple-system,system-ui'; ctx.fillText(s,x,y); }
    function fill(x,y,w,h,c){ ctx.fillStyle=c; ctx.fillRect(x,y,w,h); }
    function pointInRect(x,y,r){ return x>=r.x&&y>=r.y&&x<=r.x+r.w&&y<=r.y+r.h; }
    function playersAlive(){ var a=[]; for(var i=0;i<roster.length;i++){var u=roster[i]; if(u.alive&&u.cell) a.push(u);} return a; }
    function enemiesAlive(){ var a=[]; for(var i=0;i<enemies.length;i++){var u=enemies[i]; if(u.alive) a.push(u);} return a; }
    function unitAtCell(c,r){ for(var i=0;i<roster.length;i++){var u=roster[i]; if(u.cell&&u.cell.x===c&&u.cell.y===r&&u.alive) return u;} return null; }
    function inLeftCols(c,r){ return c>=0&&c<=1&&r>=0&&r<ROWS; }
    function occupiedAt(x,y){ var a=playersAlive().concat(enemiesAlive()); for(var i=0;i<a.length;i++){var u=a[i]; if(u.cell.x===x&&u.cell.y===y) return true;} return false; }
    function phys(d,a){ return d*(100/(100+Math.max(0,a))); }
    function mag(d,r){ return d*(100/(100+Math.max(0,r))); }

    // -------- Animation helpers --------
    function setClip(u,clip,fps){ if(u.anim.clip!==clip){ u.anim.clip=clip; u.anim.t=0; u.anim.frame=0; u.anim.fps=fps||8; } }
    function updAnim(u,dt){ u.anim.t+=dt; var f=(u.anim.t*u.anim.fps)|0; u.anim.frame=f%4; }
    function ease(t){ return 1-(1-t)*(1-t); } // easeOutQuad
    function renderPos(u){
      if(!u.move) return {cx:u.cell.x, cy:u.cell.y};
      u.move.t=Math.min(u.move.t+u.move.dt, u.move.dur);
      var a=ease(u.move.t/u.move.dur);
      var cx=u.move.from.x*(1-a)+u.move.to.x*a, cy=u.move.from.y*(1-a)+u.move.to.y*a;
      if(u.move.t>=u.move.dur){ u.move=null; if(u.role!=='melee') setClip(u,'idle',6); else setClip(u,'idle',6); }
      return {cx:cx,cy:cy};
    }
    function startMove(u,tox,toy,dt){ u.move={t:0,dt:dt, dur:0.14, from:{x:u.cell.x,y:u.cell.y}, to:{x:tox,y:toy}}; setClip(u,'walk',8); }

    // -------- Pathing --------
    function isAdj(a,b){ return a&&b&&(Math.abs(a.cell.x-b.cell.x)+Math.abs(a.cell.y-b.cell.y)===1); }
    function diagonalNudge(u,t,res){
      var dx=t.cell.x-u.cell.x, dy=t.cell.y-u.cell.y;
      if(Math.abs(dx)===1 && Math.abs(dy)===1){
        var nx=u.cell.x+Math.sign(dx), ny=u.cell.y;
        if(nx>=0&&nx<COLS&&ny>=0&&ny<ROWS && (!occupiedAt(nx,ny) || (nx===u.cell.x&&ny===u.cell.y))){
          if(!(u.lastPos && u.lastPos.x===nx && u.lastPos.y===ny)){ u.lastPos={x:u.cell.x,y:u.cell.y}; startMove(u,nx,ny,0); u.cell.x=nx; u.cell.y=ny; u.stepCool=.14; res[nx+','+ny]=1; return true; }
        }
        nx=u.cell.x; ny=u.cell.y+Math.sign(dy);
        if(nx>=0&&nx<COLS&&ny>=0&&ny<ROWS && (!occupiedAt(nx,ny) || (nx===u.cell.x&&ny===u.cell.y))){
          if(!(u.lastPos && u.lastPos.x===nx && u.lastPos.y===ny)){ u.lastPos={x:u.cell.x,y:u.cell.y}; startMove(u,nx,ny,0); u.cell.x=nx; u.cell.y=ny; u.stepCool=.14; res[nx+','+ny]=1; return true; }
        }
      }
      return false;
    }
    function nextStepBFS(u,t,res){
      var st={x:u.cell.x,y:u.cell.y}, tx=t.cell.x, ty=t.cell.y;
      var goals=[], dirs=[[1,0],[-1,0],[0,1],[0,-1]];
      for(var i=0;i<dirs.length;i++){
        var gx=tx+dirs[i][0], gy=ty+dirs[i][1];
        if(gx<0||gx>=COLS||gy<0||gy>=ROWS) continue;
        if(!occupiedAt(gx,gy) || (gx===st.x&&gy===st.y)) goals.push({x:gx,y:gy});
      }
      if(!goals.length) return null;
      var q=[st], came={}; came[st.x+','+st.y]=null;
      function valid(nx,ny){
        if(nx<0||nx>=COLS||ny<0||ny>=ROWS) return false;
        if(occupiedAt(nx,ny) && !(nx===st.x&&ny===st.y)) return false;
        if(res[nx+','+ny] && !(nx===st.x&&ny===st.y)) return false;
        if(u.lastPos && u.lastPos.x===nx && u.lastPos.y===ny) return false; return true;
      }
      while(q.length){
        var cur=q.shift();
        for(var g=0;g<goals.length;g++){ if(goals[g].x===cur.x&&goals[g].y===cur.y){
          var path=[cur], k=cur.x+','+cur.y;
          while(came[k]){ var p=came[k]; path.push(p); k=p.x+','+p.y; }
          path.reverse(); return path[1]||null;
        }}
        for(var d=0;d<dirs.length;d++){
          var nx=cur.x+dirs[d][0], ny=cur.y+dirs[d][1], nk=nx+','+ny;
          if(came[nk]) continue; if(!valid(nx,ny)) continue;
          came[nk]=cur; q.push({x:nx,y:ny});
        }
      }
      return null;
    }
    function frontlineTarget(attacker,targets){
      if(!targets.length) return null; var i, front;
      if(attacker.team==='enemy'){ var mx=-1e9; for(i=0;i<targets.length;i++) mx=Math.max(mx,targets[i].cell.x); front=[]; for(i=0;i<targets.length;i++) if(targets[i].cell.x===mx) front.push(targets[i]); }
      else { var mn=1e9; for(i=0;i<targets.length;i++) mn=Math.min(mn,targets[i].cell.x); front=[]; for(i=0;i<targets.length;i++) if(targets[i].cell.x===mn) front.push(targets[i]); }
      var same=[]; for(i=0;i<front.length;i++) if(front[i].cell.y===attacker.cell.y) same.push(front[i]); if(same.length) front=same;
      front.sort(function(a,b){return (a.hp/a.maxhp)-(b.hp/b.maxhp);}); return front[0];
    }
    function stepToward(u,t,res,dt){
      if(!t||u.role!=='melee'||isAdj(u,t)||u.stepCool>0) return false;
      if(diagonalNudge(u,t,res)) return true;
      var s=nextStepBFS(u,t,res);
      if(s){ u.lastPos={x:u.cell.x,y:u.cell.y}; startMove(u,s.x,s.y,dt); u.cell.x=s.x; u.cell.y=s.y; u.stepCool=.18; res[s.x+','+s.y]=1; return true; }
      u.stepCool=.1; return false;
    }

    // -------- Combat (instant for ranged/cleric; animated attack for melee) --------
    function act(u,isEnemy){
      var foes=isEnemy?playersAlive():enemiesAlive(); var t=frontlineTarget(u,foes); if(!t) return false;
      if(u.role==='melee'){
        if(isAdj(u,t)){ // swing
          setClip(u,'attack',12);
          var dmg=Math.max(1,Math.round(phys(u.atk,t.armor)));
          t.hp-=dmg; if(t.hp<=0) t.alive=false;
          return true;
        }
        return false;
      }else if(u.role==='ranged'){
        var dmg2=Math.max(1,Math.round(phys(u.atk,t.armor))); t.hp-=dmg2; if(t.hp<=0) t.alive=false; setClip(u,'attack',10); return true;
      }else{ // cleric
        var pool=isEnemy?enemiesAlive():playersAlive(); pool.sort(function(a,b){return (a.hp/a.maxhp)-(b.hp/b.maxhp);});
        var p=pool[0]; if(p && p.hp<p.maxhp){ p.hp=Math.min(p.maxhp,p.hp+20); setClip(u,'attack',10); return true; }
        var md=Math.max(1,Math.round(mag(Math.max(4,Math.floor(u.atk*0.5)), t.resist))); t.hp-=md; if(t.hp<=0) t.alive=false; setClip(u,'attack',10); return true;
      }
    }

    // -------- Merge & economy --------
    function refundFor(u){ return !u?BUY_COST:(u.star===1?2:u.star===2?6:18); }
    function tryMerge(name,star){
      var copies=[]; for(var i=0;i<roster.length;i++){var u=roster[i]; if(u.name===name&&u.star===star) copies.push(u);}
      if(copies.length<3) return false;
      var keep=null; for(var k=0;k<copies.length;k++){ if(copies[k].cell){keep=copies[k];break;} } if(!keep) keep=copies[0];
      var keepCell=keep.cell?{x:keep.cell.x,y:keep.cell.y}:null;
      var removed=0; for(var i=roster.length-1;i>=0&&removed<3;i--){var u=roster[i]; if(u.name===name&&u.star===star){roster.splice(i,1);removed++;}}
      var m=mkUnit(name,'player',keepCell,star+1); if(m.name==='Archer'&&m.star>=2) m.atk=Math.round(m.atk*1.10);
      roster.push(m); if(m.star<3) tryMerge(name,m.star); return true;
    }

    // -------- Battle loop --------
    function battleTick(dt){
      if(!playersAlive().length){ state='result'; result='lose'; return; }
      if(!enemiesAlive().length){ state='result'; result='win'; gold += 2 + Math.floor(floorN/2); return; }

      var used={};
      var pa=playersAlive();
      for(var i=0;i<pa.length;i++){
        var u=pa[i]; u.cool=Math.max(0,u.cool-dt); u.stepCool=Math.max(0,u.stepCool-dt); updAnim(u,dt);
        if(u.move){} else if(u.anim.clip!=='attack'){ setClip(u,'idle',6); }
        if(u.cool<=0){
          var did=act(u,false);
          if(!did && u.role==='melee'){ var tgt=frontlineTarget(u,enemiesAlive()); stepToward(u,tgt,used,dt); did=act(u,false); }
          u.cool = did ? (1/u.spd) : 0.12;
        }else if(u.role==='melee'){ var tgt2=frontlineTarget(u,enemiesAlive()); stepToward(u,tgt2,used,dt); }
      }
      if(!playersAlive().length){ state='result'; result='lose'; return; }
      if(!enemiesAlive().length){ state='result'; result='win'; gold += 2 + Math.floor(floorN/2); return; }

      used={};
      var ea=enemiesAlive();
      for(var j=0;j<ea.length;j++){
        var e=ea[j]; e.cool=Math.max(0,e.cool-dt); e.stepCool=Math.max(0,e.stepCool-dt); updAnim(e,dt);
        if(e.move){} else if(e.anim.clip!=='attack'){ setClip(e,'idle',6); }
        if(e.cool<=0){
          var did2=act(e,true);
          if(!did2 && e.role==='melee'){ var tgt3=frontlineTarget(e,playersAlive()); stepToward(e,tgt3,used,dt); did2=act(e,true); }
          e.cool = did2 ? (1/e.spd) : 0.12;
        }else if(e.role==='melee'){ var tgt4=frontlineTarget(e,playersAlive()); stepToward(e,tgt4,used,dt); }
      }
    }

    // -------- Input --------
    function clientToCanvas(e){ var r=canvas.getBoundingClientRect(); var t=e.changedTouches?e.changedTouches[0]:e; return {x:t.clientX-r.left,y:t.clientY-r.top}; }
    function cellAtFloor(px,py){ return {x:((px-L.originX)/L.cell)|0, y:((py-L.originY)/L.cell)|0}; }
    function cellAtRound(px,py){ return {x:Math.round((px-L.originX)/L.cell), y:Math.round((py-L.originY)/L.cell)}; }
    function placeExactAt(c,r){
      if(!(c>=0&&c<=1&&r>=0&&r<ROWS)) return false;
      if(unitAtCell(c,r)) return false;
      preview.cell={x:c,y:r}; roster.push(preview); tryMerge(preview.name,preview.star||1); preview=null; state='shop'; return true;
    }
    function startBattle(){
      if(!roster.some(function(u){return u.alive&&u.cell;})) return;
      spawnEnemies(); var p=playersAlive(), e=enemiesAlive();
      for(var i=0;i<p.length;i++) p[i].cool=0; for(var j=0;j<e.length;j++) e[j].cool=0;
      state='battle';
    }

    canvas.addEventListener('pointerdown',function(e){ e.preventDefault(); },{passive:false});
    canvas.addEventListener('pointerup',function(e){
      var p=clientToCanvas(e);
      if(pointInRect(p.x,p.y,shopBtn)){ SHOW_SHOP=!SHOW_SHOP; layout(); e.preventDefault(); return; }

      if(state==='result'){
        if(result==='win'){ floorN++; } else { roster=[]; enemies=[]; gold=6; floorN=1; }
        result=null; state='shop'; SHOW_SHOP=true; refillShop(); layout(); e.preventDefault(); return;
      }

      if(state==='placing'&&preview){
        if(pointInRect(p.x,p.y,sellArea)){ gold+=refundFor(preview); preview=null; state='shop'; e.preventDefault(); return; }
        var cr=cellAtRound(p.x,p.y); var cx=Math.max(0,Math.min(COLS-1,cr.x)), cy=Math.max(0,Math.min(ROWS-1,cr.y));
        placeExactAt(cx,cy); e.preventDefault(); return;
      }

      if(state==='shop'&&!preview){
        var cc=cellAtFloor(p.x,p.y);
        if(inLeftCols(cc.x,cc.y)){ var u=unitAtCell(cc.x,cc.y);
          if(u){ var idx=roster.indexOf(u); if(idx>=0) roster.splice(idx,1); preview=u; preview._fromPickup=true; state='placing'; e.preventDefault(); return; } }
        if(SHOW_SHOP && pointInRect(p.x,p.y,rerollArea)){ if(gold>=REROLL_COST){ gold-=REROLL_COST; refillShop(); } e.preventDefault(); return; }
        if(SHOW_SHOP){ for(var i=0;i<buyAreas.length;i++){ var r=buyAreas[i]; if(pointInRect(p.x,p.y,r)&&gold>=BUY_COST){ gold-=BUY_COST; preview=mkUnit(shop[r.i],'player',null,1); preview._fromPickup=false; state='placing'; e.preventDefault(); return; } } }
        if(pointInRect(p.x,p.y,startArea)){ startBattle(); e.preventDefault(); return; }
      }
    },{passive:false});

    // -------- Draw --------
    function drawUnit(u,dt){
      if(!u.alive||!u.cell) return;
      var p=renderPos(u);
      var gx=L.originX+p.cx*L.cell, gy=L.originY+p.cy*L.cell;

      // health bar
      var w=L.cell-20, hpw=Math.max(0,Math.floor(w*Math.max(0,u.hp)/u.maxhp));
      ctx.fillStyle='#333'; ctx.fillRect(gx+10,gy+L.cell-28,w,6); ctx.fillStyle=C.hp; ctx.fillRect(gx+10,gy+L.cell-28,hpw,6);

      // sprite
      var unitIndex = (u.team==='enemy')?3:(u.name==='Brawler'?0:(u.name==='Archer'?1:2));
      var atlas = SPR.atlas[unitIndex];
      var list = atlas ? atlas[u.anim.clip] : null;
      var fr = list ? list[u.anim.frame] : null;
      var pad=4, size=L.cell-pad*2;
      ctx.imageSmoothingEnabled=false;
      if(SPR.img && fr){
        if(u.anim.flip){ ctx.save(); ctx.translate(gx+pad+size, gy+pad); ctx.scale(-1,1); ctx.drawImage(SPR.img, fr.x,fr.y,fr.w,fr.h, 0,0, size,size); ctx.restore(); }
        else { ctx.drawImage(SPR.img, fr.x,fr.y,fr.w,fr.h, gx+pad,gy+pad, size,size); }
      }else{
        // fallback box if spritesheet not ready yet
        ctx.fillStyle=u.color; ctx.fillRect(gx+pad,gy+pad,size,size);
      }
    }

    function draw(dt){
      // bg & grid
      ctx.fillStyle=C.bg; ctx.fillRect(0,0,canvas.width/DPR,canvas.height/DPR);
      ctx.strokeStyle=C.grid; for(var c=0;c<COLS;c++) for(var r=0;r<ROWS;r++) ctx.strokeRect(L.originX+c*L.cell,L.originY+r*L.cell,L.cell,L.cell);
      // version tag
      ctx.fillStyle='#7bd7ff'; ctx.font='12px -apple-system,system-ui'; ctx.fillText('Build '+BUILD, L.originX+L.gridW-72, L.originY-8);

      // units
      for(var i=0;i<roster.length;i++) drawUnit(roster[i],dt);
      for(var j=0;j<enemies.length;j++) drawUnit(enemies[j],dt);

      // UI panel
      var y0=L.yUI; fill(0,y0,L.vw,uiH(),C.ui);
      // SELL
      sellArea={x:L.vw-168,y:y0+(SHOW_SHOP?60:8),w:160,h:72}; fill(sellArea.x,sellArea.y,sellArea.w,sellArea.h,'#3a2222');
      text('SELL ('+(preview?refundFor(preview):2)+'g)', sellArea.x+22, sellArea.y+44, 20, '#ff9a9a');
      // START
      startArea={x:L.vw-168,y:y0+8,w:160,h:52}; fill(startArea.x,startArea.y,startArea.w,startArea.h,C.start); text('START', startArea.x+48, startArea.y+32, 20, '#fff');
      // REROLL
      if(SHOW_SHOP){ rerollArea={x:L.vw-336,y:y0+8,w:160,h:52}; fill(rerollArea.x,rerollArea.y,rerollArea.w,rerollArea.h,'#2b2b2b'); text('REROLL (2g)', rerollArea.x+18, rerollArea.y+32, 18, C.accent); } else rerollArea={x:0,y:0,w:0,h:0};
      // GOLD
      if(SHOW_SHOP) text('GOLD: '+gold+'g', 8, y0+52, 18, C.accent);
      // shop cards
      buyAreas.length=0;
      if(SHOW_SHOP){
        var cardW=Math.min(200, L.vw/3-12), cardH=120;
        for(var i=0;i<3;i++){
          var x=8+i*(cardW+6), y=y0+60, w=cardW, h=cardH; fill(x,y,w,h,'#3a3a3a');
          var name=shop[i], b=BASE[name]; text(name+' ★', x+8, y+18, 16, '#fff');
          ctx.fillStyle='#eaeaea'; ctx.font='12px -apple-system,system-ui';
          ctx.fillText('HP: '+b.hp+'   ATK: '+b.atk, x+8, y+36);
          ctx.fillText('ARM: '+b.armor+'   RES: '+b.resist, x+8, y+52);
          fill(x+8,y+h-22,w-16,18,'#2a2a2a'); text('Buy 2 gold', x+14, y+h-8, 12, C.accent);
          buyAreas.push({x:x,y:y,w:w,h:h,i:i});
        }
      }
      // top-left toggle
      fill(shopBtn.x,shopBtn.y,shopBtn.w,shopBtn.h,'#2b2b2b'); text(SHOW_SHOP?'HIDE SHOP':'SHOW SHOP', shopBtn.x+14, shopBtn.y+34, 18, C.accent);

      // hint
      var hint=(state==='result')?'Tap to continue…':(state==='placing'?'Tap to place / SELL.':'Tap a unit to move it. Use SHOP to toggle.');
      text(hint, L.originX, Math.max(16,L.originY-6), 12, '#9ee');
    }

    // -------- Battle driver --------
    function frontlineTarget(attacker,targets){ // (duplicated small helper for speed)
      if(!targets.length) return null; var i, front;
      if(attacker.team==='enemy'){ var mx=-1e9; for(i=0;i<targets.length;i++) mx=Math.max(mx,targets[i].cell.x); front=[]; for(i=0;i<targets.length;i++) if(targets[i].cell.x===mx) front.push(targets[i]); }
      else { var mn=1e9; for(i=0;i<targets.length;i++) mn=Math.min(mn,targets[i].cell.x); front=[]; for(i=0;i<targets.length;i++) if(targets[i].cell.x===mn) front.push(targets[i]); }
      var same=[]; for(i=0;i<front.length;i++) if(front[i].cell.y===attacker.cell.y) same.push(front[i]); if(same.length) front=same;
      front.sort(function(a,b){return (a.hp/a.maxhp)-(b.hp/b.maxhp);}); return front[0];
    }
    function stepToward(u,t,res,dt){ // (duplicate signature)
      if(!t||u.role!=='melee'||(Math.abs(u.cell.x-t.cell.x)+Math.abs(u.cell.y-t.cell.y)===1)||u.stepCool>0) return false;
      if(diagonalNudge(u,t,res)) return true;
      var s=nextStepBFS(u,t,res);
      if(s){ u.lastPos={x:u.cell.x,y:u.cell.y}; startMove(u,s.x,s.y,dt); u.cell.x=s.x; u.cell.y=s.y; u.stepCool=.18; res[s.x+','+s.y]=1; return true; }
      u.stepCool=.1; return false;
    }
    function act(u,isEnemy){ // (duplicate signature)
      var foes=isEnemy?playersAlive():enemiesAlive(); var t=frontlineTarget(u,foes); if(!t) return false;
      if(u.role==='melee'){
        if(Math.abs(u.cell.x-t.cell.x)+Math.abs(u.cell.y-t.cell.y)===1){
          setClip(u,'attack',12);
          var dmg=Math.max(1,Math.round(phys(u.atk,t.armor))); t.hp-=dmg; if(t.hp<=0) t.alive=false; return true;
        }
        return false;
      }else if(u.role==='ranged'){
        var dmg2=Math.max(1,Math.round(phys(u.atk,t.armor))); t.hp-=dmg2; if(t.hp<=0) t.alive=false; setClip(u,'attack',10); return true;
      }else{
        var pool=isEnemy?enemiesAlive():playersAlive(); pool.sort(function(a,b){return (a.hp/a.maxhp)-(b.hp/b.maxhp);});
        var p=pool[0]; if(p && p.hp<p.maxhp){ p.hp=Math.min(p.maxhp,p.hp+20); setClip(u,'attack',10); return true; }
        var md=Math.max(1,Math.round(mag(Math.max(4,Math.floor(u.atk*0.5)), t.resist))); t.hp-=md; if(t.hp<=0) t.alive=false; setClip(u,'attack',10); return true;
      }
    }
    function battleTick(dt){
      if(!playersAlive().length){ state='result'; result='lose'; return; }
      if(!enemiesAlive().length){ state='result'; result='win'; gold += 2 + Math.floor(floorN/2); return; }
      var used={}, pa=playersAlive();
      for(var i=0;i<pa.length;i++){
        var u=pa[i]; u.cool=Math.max(0,u.cool-dt); u.stepCool=Math.max(0,u.stepCool-dt); updAnim(u,dt);
        if(!u.move && u.anim.clip!=='attack') setClip(u,'idle',6);
        if(u.cool<=0){
          var did=act(u,false);
          if(!did && u.role==='melee'){ var t=frontlineTarget(u,enemiesAlive()); stepToward(u,t,used,dt); did=act(u,false); }
          u.cool = did ? (1/u.spd) : 0.12;
        } else if(u.role==='melee'){
          var t2=frontlineTarget(u,enemiesAlive()); stepToward(u,t2,used,dt);
        }
      }
      if(!playersAlive().length){ state='result'; result='lose'; return; }
      if(!enemiesAlive().length){ state='result'; result='win'; gold += 2 + Math.floor(floorN/2); return; }
      used={}; var ea=enemiesAlive();
      for(var j=0;j<ea.length;j++){
        var e=ea[j]; e.cool=Math.max(0,e.cool-dt); e.stepCool=Math.max(0,e.stepCool-dt); updAnim(e,dt);
        if(!e.move && e.anim.clip!=='attack') setClip(e,'idle',6);
        if(e.cool<=0){
          var did2=act(e,true);
          if(!did2 && e.role==='melee'){ var t3=frontlineTarget(e,playersAlive()); stepToward(e,t3,used,dt); did2=act(e,true); }
          e.cool = did2 ? (1/e.spd) : 0.12;
        } else if(e.role==='melee'){
          var t4=frontlineTarget(e,playersAlive()); stepToward(e,t4,used,dt);
        }
      }
    }

    // -------- Render + UI panel --------
    var startArea={}, rerollArea={}, sellArea={};
    function drawUI(){
      var y0=L.yUI; fill(0,y0,L.vw,uiH(),C.ui);
      // SELL
      sellArea={x:L.vw-168,y:y0+(SHOW_SHOP?60:8),w:160,h:72}; fill(sellArea.x,sellArea.y,sellArea.w,sellArea.h,'#3a2222');
      text('SELL ('+(preview?refundFor(preview):2)+'g)', sellArea.x+22, sellArea.y+44, 20, '#ff9a9a');
      // START
      startArea={x:L.vw-168,y:y0+8,w:160,h:52}; fill(startArea.x,startArea.y,startArea.w,startArea.h,C.start); text('START', startArea.x+48, startArea.y+32, 20, '#fff');
      // REROLL
      if(SHOW_SHOP){ rerollArea={x:L.vw-336,y:y0+8,w:160,h:52}; fill(rerollArea.x,rerollArea.y,rerollArea.w,rerollArea.h,'#2b2b2b'); text('REROLL (2g)', rerollArea.x+18, rerollArea.y+32, 18, C.accent);} else rerollArea={x:0,y:0,w:0,h:0};
      // GOLD
      if(SHOW_SHOP) text('GOLD: '+gold+'g',8,y0+52,18,C.accent);
      // shop cards
      buyAreas.length=0;
      if(SHOW_SHOP){
        var cardW=Math.min(200, L.vw/3-12), cardH=120;
        for(var i=0;i<3;i++){
          var x=8+i*(cardW+6), y=y0+60, w=cardW, h=cardH; fill(x,y,w,h,'#3a3a3a');
          var name=shop[i], b=BASE[name]; text(name+' ★', x+8, y+18, 16, '#fff');
          ctx.fillStyle='#eaeaea'; ctx.font='12px -apple-system,system-ui';
          ctx.fillText('HP: '+b.hp+'   ATK: '+b.atk, x+8, y+36);
          ctx.fillText('ARM: '+b.armor+'   RES: '+b.resist, x+8, y+52);
          fill(x+8,y+h-22,w-16,18,'#2a2a2a'); text('Buy 2 gold', x+14, y+h-8, 12, C.accent);
          buyAreas.push({x:x,y:y,w:w,h:h,i:i});
        }
      }
      // top-left toggle
      fill(shopBtn.x,shopBtn.y,shopBtn.w,shopBtn.h,'#2b2b2b'); text(SHOW_SHOP?'HIDE SHOP':'SHOW SHOP', shopBtn.x+14, shopBtn.y+34, 18, C.accent);
    }

    // -------- Boot & loop --------
    function refillAndShow(){ refillShop(); ok(); }
    refillAndShow();
    var last=performance.now();
    function loop(ts){
      var dt=Math.min(.05,(ts-last)/1000); last=ts;
      // recompute layout if needed
      layout();
      // bg & grid
      ctx.fillStyle=C.bg; ctx.fillRect(0,0,canvas.width/DPR,canvas.height/DPR);
      ctx.strokeStyle=C.grid; for(var c=0;c<COLS;c++) for(var r=0;r<ROWS;r++) ctx.strokeRect(L.originX+c*L.cell,L.originY+r*L.cell,L.cell,L.cell);
      // version tag
      ctx.fillStyle='#7bd7ff'; ctx.font='12px -apple-system,system-ui'; ctx.fillText('Build '+BUILD, L.originX+L.gridW-72, L.originY-8);

      // battle
      if(state==='battle') battleTick(dt);

      // draw units
      for(var i=0;i<roster.length;i++) drawUnit(roster[i],dt);
      for(var j=0;j<enemies.length;j++) drawUnit(enemies[j],dt);

      // UI
      drawUI();

      // hint
      var hint=(state==='result')?'Tap to continue…':(state==='placing'?'Tap to place / SELL.':'Tap a unit to move it. Use SHOP to toggle.');
      text(hint, L.originX, Math.max(16,L.originY-6), 12, '#9ee');

      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);

  }catch(e){ fail(e); }
})();
</script>
</body>
</html>
