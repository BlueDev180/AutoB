<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
<title>Auto Battler – v63-safe</title>
<style>
  html,body{margin:0;padding:0;background:#121214;height:100svh;overscroll-behavior:none;font-family:-apple-system,system-ui,sans-serif}
  #boot{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#eaeaea;gap:8px}
  #boot .tag{color:#7bd7ff;font-size:12px}
  #boot.err{background:#1a0000}
  #boot.err .msg{max-width:92vw;color:#ffb8b8;white-space:pre-wrap;text-align:center}
  canvas{position:fixed;left:0;top:0;width:100vw;height:100svh;display:none;touch-action:manipulation}
</style>
</head>
<body>
<div id="boot">
  <div class="tag">Build v63-safe</div>
  <div>Loading…</div>
  <div class="msg"></div>
</div>
<canvas id="c"></canvas>

<script>
(function(){
  var BUILD="v63-safe";
  var boot=document.getElementById('boot');
  var bootMsg=boot.querySelector('.msg');
  function ok(){ boot.style.display='none'; document.getElementById('c').style.display='block'; }
  function fail(e){ boot.classList.add('err'); bootMsg.textContent=(e&&(e.stack||e.message))?(e.stack||e.message):String(e); }

  try{
    // ---------- Canvas & layout ----------
    var canvas=document.getElementById('c');
    var ctx=canvas.getContext('2d',{alpha:false});
    function vv(){ var v=window.visualViewport; var w=Math.min(innerWidth||1e9, document.documentElement.clientWidth||1e9, v?v.width:1e9);
                   var h=Math.min(innerHeight||1e9, document.documentElement.clientHeight||1e9, v?v.height:1e9); return {w:Math.floor(w),h:Math.floor(h)}; }
    function isPortrait(){ var s=vv(); return s.h>s.w; }
    var COLS=5, ROWS=3;
    var L={cell:48,originX:0,originY:24,gridW:0,gridH:0,yUI:0,vw:0,vh:0};
    var SHOW_SHOP=true, UI_SHOP=196, UI_COMPACT=96;
    function uiH(){ return SHOW_SHOP?UI_SHOP:UI_COMPACT; }
    function setCanvasSize(){ var dpr=Math.max(1, devicePixelRatio||1); var s=vv();
      canvas.width=Math.floor(s.w*dpr); canvas.height=Math.floor(s.h*dpr);
      canvas.style.width=s.w+"px"; canvas.style.height=s.h+"px"; ctx.setTransform(dpr,0,0,dpr,0,0); }
    function layout(){ var s=vv(), TOP=36, BTM=2, availH=Math.max(60, s.h-uiH()-TOP-BTM);
      var cell=Math.max(14, Math.min(Math.floor(availH/ROWS), Math.floor(s.w/COLS)));
      var gw=COLS*cell, gh=ROWS*cell, ox=Math.floor((s.w-gw)/2);
      var oy=Math.floor((s.h-uiH()-gh)/2); oy=Math.max(12, Math.min(oy, s.h-uiH()-gh-8));
      var yUI=s.h-uiH()-BTM; yUI=Math.max(oy+gh+8, yUI);
      L={cell:cell,originX:ox,originY:oy,gridW:gw,gridH:gh,yUI:yUI,vw:s.w,vh:s.h}; }
    function resize(){ setCanvasSize(); layout(); }
    window.addEventListener('resize',resize,{passive:true});
    window.addEventListener('orientationchange',resize,{passive:true});
    if(window.visualViewport){
      window.visualViewport.addEventListener('resize',resize,{passive:true});
      window.visualViewport.addEventListener('scroll',resize,{passive:true});
    }
    resize();

    // ---------- Colors ----------
    var C={ bg:'#121214', grid:'#2b2b2b', ui:'#1e1e1e', hp:'#e43a3a', t:'#eaeaea', accent:'#ffd45a', start:'#7a50a0',
            b:'#c8503c', a:'#50c85a', c:'#78b4dc', e:'#b3b3b3' };

    // ---------- Units ----------
    var BASE={
      Brawler:{hp:120, atk:18, spd:1.0, range:1, color:C.b, role:'melee', armor:10, resist:5},
      Archer: {hp:70,  atk:25, spd:0.8, range:5, color:C.a, role:'ranged', armor:4,  resist:4},
      Cleric: {hp:80,  atk:8,  spd:1.0, range:5, color:C.c, role:'healer', armor:6,  resist:12}
    };
    function starMul(s){ return s===1?1:(s===2?1.4:1.8); }
    function scaled(b,s){ return {hp:Math.round(b.hp*starMul(s)), atk:Math.round(b.atk*starMul(s)), spd:b.spd, range:b.range,
                                  color:b.color, role:b.role, armor:Math.round(b.armor*starMul(s)), resist:Math.round(b.resist*starMul(s))}; }
    function mkUnit(name,team,cell,star){ if(!star) star=1; var s=scaled(BASE[name],star);
      return {name:name,team:team,cell:cell,star:star,alive:true,maxhp:s.hp,hp:s.hp,atk:s.atk,spd:s.spd,range:s.range,
              color:s.color,role:s.role,armor:s.armor,resist:s.resist,cool:0,stepCool:0,lastPos:null}; }

    // ---------- Game state ----------
    var gold=6, floorN=1, state='shop', result=null;
    var roster=[], enemies=[], shop=[], preview=null;
    var buyAreas=[], startArea={x:0,y:0,w:0,h:0}, rerollArea={x:0,y:0,w:0,h:0}, sellArea={x:0,y:0,w:0,h:0};
    var shopBtn={x:16,y:20,w:160,h:54};
    var BUY_COST=2, REROLL_COST=2;

    function refillShop(){ var k=Object.keys(BASE); shop=[]; for(var i=0;i<3;i++){ shop.push(k[(Math.random()*k.length)|0]); } }
    function spawnEnemies(){
      enemies=[];
      var count=(floorN===1)?2:3, cols=[4,3,4,3];
      for(var i=0;i<count;i++){
        var hp=Math.floor((floorN===1)?80:90+floorN*8), atk=Math.floor((floorN===1)?10:10+floorN*3);
        enemies.push({name:'Enemy',team:'enemy',cell:{x:cols[i%cols.length],y:i%3},star:1,alive:true,maxhp:hp,hp:hp,
                      atk:atk,spd:1.0,range:1,color:C.e,role:'melee',armor:5+floorN,resist:3+((floorN/2)|0),
                      cool:0,stepCool:0,lastPos:null});
      }
    }

    // ---------- Helpers ----------
    function fill(x,y,w,h,c){ ctx.fillStyle=c; ctx.fillRect(x,y,w,h); }
    function text(t,x,y,s,c){ ctx.fillStyle=c; ctx.font=(s||16)+'px -apple-system,system-ui,sans-serif'; ctx.fillText(t,x,y); }
    function cellCenter(x,y){ return {x:L.originX+x*L.cell+L.cell/2, y:L.originY+y*L.cell+L.cell/2}; }
    function unitAtCell(c,r){ for(var i=0;i<roster.length;i++){var u=roster[i]; if(u.cell && u.cell.x===c && u.cell.y===r && u.alive) return u;} return null; }
    function playersAlive(){ var a=[]; for(var i=0;i<roster.length;i++){var u=roster[i]; if(u.alive && u.cell) a.push(u);} return a; }
    function enemiesAlive(){ var a=[]; for(var i=0;i<enemies.length;i++){var u=enemies[i]; if(u.alive) a.push(u);} return a; }
    function inLeftCols(c,r){ return c>=0 && c<=1 && r>=0 && r<ROWS; }
    function pointInRect(x,y,r){ return x>=r.x && y>=r.y && y<=r.y+r.h && x<=r.x+r.w; }
    function occupiedAt(x,y){ var a=playersAlive().concat(enemiesAlive()); for(var i=0;i<a.length;i++){var u=a[i]; if(u.cell.x===x && u.cell.y===y) return true;} return false; }
    function isAdj(a,b){ return a&&b && (Math.abs(a.cell.x-b.cell.x)+Math.abs(a.cell.y-b.cell.y)===1); }
    function phys(d,a){ return d*(100/(100+Math.max(0,a))); }
    function mag(d,r){ return d*(100/(100+Math.max(0,r))); }

    // ---------- Pathing (simple + diagonal nudge + BFS) ----------
    function diagonalNudge(u,t,res){
      var dx=t.cell.x-u.cell.x, dy=t.cell.y-u.cell.y;
      if(Math.abs(dx)===1 && Math.abs(dy)===1){
        // try horizontal first, then vertical
        var nx=u.cell.x+Math.sign(dx), ny=u.cell.y;
        if(nx>=0&&nx<COLS&&ny>=0&&ny<ROWS && (!occupiedAt(nx,ny) || (nx===u.cell.x&&ny===u.cell.y))){
          if(!(u.lastPos && u.lastPos.x===nx && u.lastPos.y===ny)){
            u.lastPos={x:u.cell.x,y:u.cell.y}; u.cell.x=nx; u.cell.y=ny; u.stepCool=.14; res[nx+','+ny]=1; return true;
          }
        }
        nx=u.cell.x; ny=u.cell.y+Math.sign(dy);
        if(nx>=0&&nx<COLS&&ny>=0&&ny<ROWS && (!occupiedAt(nx,ny) || (nx===u.cell.x&&ny===u.cell.y))){
          if(!(u.lastPos && u.lastPos.x===nx && u.lastPos.y===ny)){
            u.lastPos={x:u.cell.x,y:u.cell.y}; u.cell.x=nx; u.cell.y=ny; u.stepCool=.14; res[nx+','+ny]=1; return true;
          }
        }
      }
      return false;
    }
    function nextStepBFS(u,t,res){
      var st={x:u.cell.x,y:u.cell.y}, tx=t.cell.x, ty=t.cell.y;
      var goals=[], dirs=[[1,0],[-1,0],[0,1],[0,-1]];
      for(var i=0;i<dirs.length;i++){
        var gx=tx+dirs[i][0], gy=ty+dirs[i][1];
        if(gx<0||gx>=COLS||gy<0||gy>=ROWS) continue;
        if(!occupiedAt(gx,gy) || (gx===st.x && gy===st.y)) goals.push({x:gx,y:gy});
      }
      if(!goals.length) return null;
      var q=[st], came={}; came[st.x+','+st.y]=null;
      function valid(nx,ny){
        if(nx<0||nx>=COLS||ny<0||ny>=ROWS) return false;
        if(occupiedAt(nx,ny) && !(nx===st.x&&ny===st.y)) return false;
        if(res[nx+','+ny] && !(nx===st.x&&ny===st.y)) return false;
        if(u.lastPos && u.lastPos.x===nx && u.lastPos.y===ny) return false;
        return true;
      }
      while(q.length){
        var cur=q.shift();
        for(var i=0;i<goals.length;i++){ if(goals[i].x===cur.x && goals[i].y===cur.y){
          // reconstruct
          var path=[cur], k=cur.x+','+cur.y;
          while(came[k]){ var p=came[k]; path.push(p); k=p.x+','+p.y; }
          path.reverse(); return path[1]||null;
        }}
        for(var i=0;i<dirs.length;i++){
          var nx=cur.x+dirs[i][0], ny=cur.y+dirs[i][1], nk=nx+','+ny;
          if(came[nk]) continue;
          if(!valid(nx,ny)) continue;
          came[nk]=cur; q.push({x:nx,y:ny});
        }
      }
      return null;
    }
    function stepToward(u,t,res){
      if(!t || u.role!=='melee' || isAdj(u,t) || u.stepCool>0) return false;
      if(diagonalNudge(u,t,res)) return true;
      var s=nextStepBFS(u,t,res);
      if(s){ u.lastPos={x:u.cell.x,y:u.cell.y}; u.cell.x=s.x; u.cell.y=s.y; u.stepCool=.18; res[s.x+','+s.y]=1; return true; }
      u.stepCool=.1; return false;
    }

    // ---------- Combat (instant; no projectiles) ----------
    function frontlineTarget(attacker,ts){
      if(!ts.length) return null; var front, i;
      if(attacker.team==='enemy'){ var mx=-1e9; for(i=0;i<ts.length;i++) mx=Math.max(mx,ts[i].cell.x); front=[]; for(i=0;i<ts.length;i++) if(ts[i].cell.x===mx) front.push(ts[i]); }
      else { var mn=1e9; for(i=0;i<ts.length;i++) mn=Math.min(mn,ts[i].cell.x); front=[]; for(i=0;i<ts.length;i++) if(ts[i].cell.x===mn) front.push(ts[i]); }
      var same=[]; for(i=0;i<front.length;i++) if(front[i].cell.y===attacker.cell.y) same.push(front[i]); if(same.length) front=same;
      front.sort(function(a,b){return (a.hp/a.maxhp)-(b.hp/b.maxhp);});
      return front[0];
    }
    function act(u,enemySide){
      var foes=enemySide?playersAlive():enemiesAlive(); var t=frontlineTarget(u,foes); if(!t) return false;
      if(u.role==='melee'){
        if(isAdj(u,t)){ var dmg=Math.max(1,Math.round(phys(u.atk,t.armor))); t.hp-=dmg; if(t.hp<=0) t.alive=false; return true; }
        return false;
      }else if(u.role==='ranged'){
        var dmg2=Math.max(1,Math.round(phys(u.atk,t.armor))); t.hp-=dmg2; if(t.hp<=0) t.alive=false; return true;
      }else{ // cleric
        var pool=enemySide?enemiesAlive():playersAlive(); pool.sort(function(a,b){return (a.hp/a.maxhp)-(b.hp/b.maxhp);});
        var p=pool[0]; if(p && p.hp<p.maxhp){ p.hp=Math.min(p.maxhp,p.hp+20); return true; }
        var md=Math.max(1,Math.round(mag(Math.max(4,Math.floor(u.atk*0.5)), t.resist))); t.hp-=md; if(t.hp<=0) t.alive=false; return true;
      }
    }

    // ---------- Merge & economy ----------
    function refundFor(u){ return !u?BUY_COST:(u.star===1?2:u.star===2?6:18); }
    function tryMerge(name,star){
      var copies=[]; for(var i=0;i<roster.length;i++){var u=roster[i]; if(u.name===name && u.star===star) copies.push(u);}
      if(copies.length<3) return false;
      var keep=null; for(var i=0;i<copies.length;i++){ if(copies[i].cell){ keep=copies[i]; break; } }
      if(!keep) keep=copies[0];
      var keepCell=keep.cell?{x:keep.cell.x,y:keep.cell.y}:null;
      var removed=0; for(var i=roster.length-1;i>=0 && removed<3;i--){var u=roster[i]; if(u.name===name && u.star===star){ roster.splice(i,1); removed++; }}
      var m=mkUnit(name,'player',keepCell,star+1); if(m.name==='Archer' && m.star>=2) m.atk=Math.round(m.atk*1.10);
      roster.push(m); if(m.star<3) tryMerge(name,m.star); return true;
    }

    // ---------- Battle loop ----------
    function battleTick(dt){
      if(!playersAlive().length){ state='result'; result='lose'; return; }
      if(!enemiesAlive().length){ state='result'; result='win'; gold += 2 + Math.floor(floorN/2); return; }

      var used={};
      // players
      var pa=playersAlive();
      for(var i=0;i<pa.length;i++){
        var u=pa[i]; u.cool=Math.max(0,u.cool-dt); u.stepCool=Math.max(0,u.stepCool-dt);
        if(u.cool<=0){
          var did=act(u,false);
          if(!did && u.role==='melee'){ var tgt=frontlineTarget(u,enemiesAlive()); stepToward(u,tgt,used); did=act(u,false); }
          u.cool = did ? (1/u.spd) : 0.12;
        }else if(u.role==='melee'){ var tgt=frontlineTarget(u,enemiesAlive()); stepToward(u,tgt,used); }
      }
      if(!playersAlive().length){ state='result'; result='lose'; return; }
      if(!enemiesAlive().length){ state='result'; result='win'; gold += 2 + Math.floor(floorN/2); return; }

      used={};
      // enemies
      var ea=enemiesAlive();
      for(var j=0;j<ea.length;j++){
        var e=ea[j]; e.cool=Math.max(0,e.cool-dt); e.stepCool=Math.max(0,e.stepCool-dt);
        if(e.cool<=0){
          var did2=act(e,true);
          if(!did2 && e.role==='melee'){ var tgt2=frontlineTarget(e,playersAlive()); stepToward(e,tgt2,used); did2=act(e,true); }
          e.cool = did2 ? (1/e.spd) : 0.12;
        }else if(e.role==='melee'){ var tgt3=frontlineTarget(e,playersAlive()); stepToward(e,tgt3,used); }
      }
    }

    // ---------- Input ----------
    function clientToCanvas(e){ var r=canvas.getBoundingClientRect(); var t=e.changedTouches?e.changedTouches[0]:e; return {x:t.clientX-r.left,y:t.clientY-r.top}; }
    function cellAtFloor(px,py){ return {x:((px-L.originX)/L.cell)|0, y:((py-L.originY)/L.cell)|0}; }
    function cellAtRound(px,py){ return {x:Math.round((px-L.originX)/L.cell), y:Math.round((py-L.originY)/L.cell)}; }
    function placeExactAt(c,r){
      if(!inLeftCols(c,r)){ return false; }
      if(unitAtCell(c,r)){ return false; }
      preview.cell={x:c,y:r}; roster.push(preview); tryMerge(preview.name,preview.star||1); preview=null; state='shop'; return true;
    }
    function startBattle(){
      if(!roster.some(function(u){return u.alive&&u.cell;})) return;
      spawnEnemies(); var p=playersAlive(), e=enemiesAlive();
      for(var i=0;i<p.length;i++) p[i].cool=0; for(var j=0;j<e.length;j++) e[j].cool=0;
      state='battle';
    }

    canvas.addEventListener('pointerdown',function(e){ if(isPortrait()) e.preventDefault(); },{passive:false});
    canvas.addEventListener('pointerup',function(e){
      if(isPortrait()){ e.preventDefault(); return; }
      var p=clientToCanvas(e);

      // toggle shop (top-left)
      if(pointInRect(p.x,p.y,shopBtn)){ SHOW_SHOP=!SHOW_SHOP; layout(); e.preventDefault(); return; }

      if(state==='result'){
        if(result==='win'){ floorN++; } else { roster=[]; enemies=[]; gold=6; floorN=1; }
        result=null; state='shop'; SHOW_SHOP=true; refillShop(); layout(); e.preventDefault(); return;
      }

      if(state==='placing' && preview){
        if(pointInRect(p.x,p.y,sellArea)){ gold+=refundFor(preview); preview=null; state='shop'; e.preventDefault(); return; }
        var cr=cellAtRound(p.x,p.y); var cx=Math.max(0,Math.min(COLS-1,cr.x)), cy=Math.max(0,Math.min(ROWS-1,cr.y));
        placeExactAt(cx,cy); e.preventDefault(); return;
      }

      if(state==='shop' && !preview){
        var cc=cellAtFloor(p.x,p.y);
        // pick up
        if(inLeftCols(cc.x,cc.y)){ var u=unitAtCell(cc.x,cc.y); if(u){ var idx=roster.indexOf(u); if(idx>=0) roster.splice(idx,1); preview=u; preview._fromPickup=true; state='placing'; e.preventDefault(); return; } }
        // reroll
        if(SHOW_SHOP && pointInRect(p.x,p.y,rerollArea)){ if(gold>=REROLL_COST){ gold-=REROLL_COST; refillShop(); } e.preventDefault(); return; }
        // buy
        if(SHOW_SHOP){ for(var i=0;i<buyAreas.length;i++){ var r=buyAreas[i]; if(pointInRect(p.x,p.y,r) && gold>=BUY_COST){ gold-=BUY_COST; preview=mkUnit(shop[r.i],'player',null,1); preview._fromPickup=false; state='placing'; e.preventDefault(); return; } } }
        // start
        if(pointInRect(p.x,p.y,startArea)){ startBattle(); e.preventDefault(); return; }
      }
    },{passive:false});

    // ---------- Render ----------
    function draw(){
      // bg & grid
      ctx.fillStyle=C.bg; ctx.fillRect(0,0,L.vw,L.vh);
      ctx.strokeStyle=C.grid; for(var c=0;c<COLS;c++) for(var r=0;r<ROWS;r++) ctx.strokeRect(L.originX+c*L.cell,L.originY+r*L.cell,L.cell,L.cell);
      // version
      ctx.fillStyle='#7bd7ff'; ctx.font='12px -apple-system,system-ui'; ctx.fillText('Build '+BUILD, L.originX+L.gridW-72, L.originY-8);

      // hint
      var hint=(state==='result')?'Tap to continue…':(state==='placing'?'Tap to place / SELL.':'Tap a unit to move it. Use SHOP to toggle.');
      text(hint,L.originX,Math.max(16,L.originY-6),12,'#9ee');

      // units
      function drawU(u){
        if(!u.alive||!u.cell) return;
        var gx=L.originX+u.cell.x*L.cell, gy=L.originY+u.cell.y*L.cell;
        ctx.fillStyle=u.color; ctx.fillRect(gx+8,gy+8,L.cell-16,L.cell-16);
        var w=L.cell-20, hpw=Math.max(0,Math.floor(w*Math.max(0,u.hp)/u.maxhp));
        ctx.fillStyle='#333'; ctx.fillRect(gx+10,gy+L.cell-28,w,6); ctx.fillStyle=C.hp; ctx.fillRect(gx+10,gy+L.cell-28,hpw,6);
      }
      for(var i=0;i<roster.length;i++) drawU(roster[i]);
      for(var j=0;j<enemies.length;j++) drawU(enemies[j]);

      // UI panel
      var y0=L.yUI; fill(0,y0,L.vw,uiH(),C.ui);

      // SELL
      sellArea={x:L.vw-168,y:y0+(SHOW_SHOP?60:8),w:160,h:72}; fill(sellArea.x,sellArea.y,sellArea.w,sellArea.h,'#3a2222');
      text('SELL ('+(preview?refundFor(preview):2)+'g)', sellArea.x+22, sellArea.y+44, 20, '#ff9a9a');

      // START
      startArea={x:L.vw-168,y:y0+8,w:160,h:52}; fill(startArea.x,startArea.y,startArea.w,startArea.h,C.start);
      text('START', startArea.x+48, startArea.y+32, 20, '#fff');

      // REROLL
      if(SHOW_SHOP){ rerollArea={x:L.vw-336,y:y0+8,w:160,h:52}; fill(rerollArea.x,rerollArea.y,rerollArea.w,rerollArea.h,'#2b2b2b');
        text('REROLL (2g)', rerollArea.x+18, rerollArea.y+32, 18, C.accent); } else { rerollArea={x:0,y:0,w:0,h:0}; }

      // GOLD
      if(SHOW_SHOP) text('GOLD: '+gold+'g', 8, y0+52, 18, C.accent);

      // shop cards
      buyAreas.length=0;
      if(SHOW_SHOP){
        var cardW=Math.min(200, L.vw/3-12), cardH=120;
        for(var i=0;i<3;i++){
          var x=8+i*(cardW+6), y=y0+60, w=cardW, h=cardH; fill(x,y,w,h,'#3a3a3a');
          var name=shop[i], b=BASE[name]; text(name+' ★', x+8, y+18, 16, '#fff');
          ctx.fillStyle='#eaeaea'; ctx.font='12px -apple-system,system-ui';
          ctx.fillText('HP: '+b.hp+'   ATK: '+b.atk, x+8, y+36);
          ctx.fillText('ARM: '+b.armor+'   RES: '+b.resist, x+8, y+52);
          fill(x+8, y+h-22, w-16, 18, '#2a2a2a'); text('Buy 2 gold', x+14, y+h-8, 12, C.accent);
          buyAreas.push({x:x,y:y,w:w,h:h,i:i});
        }
      }

      // top-left toggle button
      fill(shopBtn.x,shopBtn.y,shopBtn.w,shopBtn.h,'#2b2b2b');
      text(SHOW_SHOP?'HIDE SHOP':'SHOW SHOP', shopBtn.x+14, shopBtn.y+34, 18, C.accent);

      // mini debug
      var dbgX=L.vw-200, dbgY=8;
      ctx.fillStyle='rgba(0,0,0,0.5)'; ctx.fillRect(dbgX,dbgY,190,48);
      ctx.fillStyle='#9ee'; ctx.font='12px -apple-system,system-ui';
      ctx.fillText('state: '+state, dbgX+8, dbgY+18);
      ctx.fillText('P:'+playersAlive().length+'  E:'+enemiesAlive().length, dbgX+8, dbgY+36);
    }

    // ---------- Boot & loop ----------
    function bootGame(){ state='shop'; SHOW_SHOP=true; refillShop(); ok(); }
    bootGame();
    var last=performance.now();
    function loop(ts){
      var dt=Math.min(.05,(ts-last)/1000); last=ts;
      if(!isPortrait()){
        if(state==='battle') battleTick(dt);
      }
      draw();
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);

  }catch(e){ fail(e); }
})();
</script>
</body>
</html>
